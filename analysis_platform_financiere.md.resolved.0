# üè¶ Analyse Compl√®te - Plateforme Financi√®re Microservices Zekora

## Vue d'Ensemble

Cette plateforme est une application bancaire crypto compl√®te bas√©e sur une architecture microservices. Elle combine les services bancaires traditionnels (fiat) avec les cryptomonnaies, offrant des fonctionnalit√©s comme les cartes pr√©pay√©es, les transferts internationaux, le trading P2P, et plus encore.

---

## üìä Architecture Globale

### Infrastructure Docker

| Composant | R√¥le | Port |
|-----------|------|------|
| **PostgreSQL** | Base de donn√©es principale | 5432 |
| **MongoDB** | Messagerie, tickets, support | 27017 |
| **Redis** | Cache et sessions | 6379 |
| **Kafka + Zookeeper** | Event-driven messaging | 9092 |
| **RabbitMQ** | File de messages card-service | 5672 |
| **Vault (HashiCorp)** | Stockage s√©curis√© des cl√©s priv√©es | 8200 |
| **MinIO** | Stockage objets (KYC, images) | 9000 |
| **Kong** | API Gateway | 8080 |
| **Prometheus + Grafana** | Monitoring | 9090, 3001 |

### Microservices (14 services)

```mermaid
graph TB
    subgraph "Frontend"
        FE[Frontend App :3000]
        AD[Admin Dashboard :3002]
    end
    
    subgraph "API Gateway"
        GW[Kong Gateway :8080]
        AGW[Admin API :8088]
    end
    
    subgraph "Core Services"
        AUTH[Auth Service :8081]
        WALLET[Wallet Service :8083]
        TRANSFER[Transfer Service :8084]
        EXCHANGE[Exchange Service :8085]
        CARD[Card Service :8086]
    end
    
    subgraph "Supporting Services"
        NOTIF[Notification :8087]
        ADMIN[Admin Service :8088]
        SUPPORT[Support Service :8089]
        TICKET[Ticket Service :8090]
        MSG[Messaging :8095]
        DONATE[Donation :8096]
        ENTERPRISE[Enterprise :8097]
        SHOP[Shop :8098]
    end
    
    FE --> GW
    AD --> AGW
    GW --> AUTH & WALLET & TRANSFER & EXCHANGE & CARD
    AGW --> ADMIN
```

---

## üí∞ Analyse Financi√®re D√©taill√©e

### 1. D√©p√¥ts (Deposits)

#### D√©p√¥ts Crypto - Architecture Hybride

| Type | M√©canisme | Blockchain TX | Avantage |
|------|-----------|---------------|----------|
| **Adresse Unique** | BTC, ETH, SOL, TRX | Sweep vers Hot Wallet | S√©curit√© maximale |
| **Memo/Tag** | XRP, XLM, TON | Direct sur Hot Wallet | Aucun frais de sweep |
| **Interne** | User ‚Üí User | Aucune TX | Instantan√©, gratuit |

**Cryptos support√©es** :
- BTC (Bitcoin) - Native SegWit (Bech32)
- ETH (Ethereum) + Tokens ERC-20
- SOL (Solana)
- TRX (TRON) + Tokens TRC-20
- XRP (Ripple) - Memo-based
- TON (The Open Network)
- BNB (Binance Smart Chain)

**Flux de d√©p√¥t** :
```
1. User demande adresse de d√©p√¥t
2. Syst√®me g√©n√®re adresse unique OU retourne Hot Wallet + Memo
3. User envoie crypto √† l'adresse
4. Webhook Tatum d√©tecte la transaction
5. Balance cr√©dit√©e apr√®s confirmations
6. Si adresse unique: Sweep automatique vers Hot Wallet
```

#### D√©p√¥ts Fiat - Providers

| Provider | Pays | Devises | Type |
|----------|------|---------|------|
| **Demo Mode** | Tous | XOF, XAF, NGN, GHS, USD, EUR | Test |
| **Flutterwave** | NG, GH, KE, CI | NGN, GHS, XOF | Mobile Money, Card, Bank |
| **CinetPay** | CI, SN, CM, BF | XOF, XAF | Mobile Money |
| **Paystack** | NG, GH | NGN, GHS | Card, Bank |
| **Orange Money** | CI, SN | XOF | Mobile Money |
| **MTN MoMo** | CI, CM, GH | XOF, XAF, GHS | Mobile Money |
| **Wave** | SN, CI | XOF | Mobile Money |
| **Stripe** | International | USD, EUR, GBP | Card |

> ‚ö†Ô∏è **Mode D√©mo actif** : En d√©veloppement, le mode d√©mo cr√©dite directement les comptes sans passer par les APIs de paiement r√©elles.

---

### 2. Retraits (Withdrawals)

#### Retraits Crypto

**Flux** :
```
1. User initie retrait vers adresse externe
2. V√©rification PIN s√©curis√© (5 digits)
3. Calcul des frais r√©seau
4. D√©bit du wallet DB
5. Transaction depuis Platform Hot Wallet
6. Monitoring des confirmations
7. Statut mis √† jour: pending ‚Üí confirmed
```

**Fonctions cl√©s** ([wallet_service.go](file:///C:/Users/D/Desktop/ai/microservices-financial-app/services/wallet-service/internal/services/wallet_service.go)) :
- [processExternalCryptoTransfer()](file:///C:/Users/D/Desktop/ai/microservices-financial-app/services/wallet-service/internal/services/wallet_service.go#343-438) - Retraits externes
- [processInternalCryptoTransfer()](file:///C:/Users/D/Desktop/ai/microservices-financial-app/services/wallet-service/internal/services/wallet_service.go#275-342) - Transferts internes (gratuits)

#### Retraits Fiat

Via les m√™mes providers que les d√©p√¥ts (Flutterwave, MoMo, etc.)

---

### 3. Transferts Internes

**Types de transferts** :

| Type | Description | Frais |
|------|-------------|-------|
| **wallet_to_wallet** | Entre wallets du m√™me user | 0% |
| **user_to_user** | Vers un autre utilisateur | Variable |
| **merchant** | Paiement marchand | ~1-2% |
| **enterprise_payroll** | Paie en masse | Variable |

**Service** : `transfer-service` (Port 8084)

**Mod√®le Event-Driven** :
```
1. Service A publie sur Kafka topic "payment_requests"
2. transfer-service consomme et traite
3. Appel wallet-service pour d√©bit/cr√©dit
4. R√©sultat publi√© sur "payment_results"
5. Service A re√ßoit confirmation
```

---

### 4. Transferts Externes

**Types support√©s** :

- **Mobile Money** : Envoi vers num√©ros de t√©l√©phone (Orange, MTN, Wave)
- **Transferts Internationaux** : Via Thunes API
- **Virements Bancaires** : Via Stripe/Flutterwave

**Service** : [InternationalTransferService](file:///C:/Users/D/Desktop/ai/microservices-financial-app/services/transfer-service/internal/services/transfer.go#608-611) dans transfer-service

---

### 5. Transactions Crypto

#### G√©n√©ration d'Adresses ([crypto_service.go](file:///C:/Users/D/Desktop/ai/microservices-financial-app/services/wallet-service/internal/services/crypto_service.go))

| Crypto | Algorithme | Format d'adresse |
|--------|------------|------------------|
| BTC | secp256k1 | Bech32 (bc1/tb1) |
| ETH | secp256k1 | 0x... (40 hex) |
| SOL | Ed25519 | Base58 |
| TRX | secp256k1 | Base58Check (T...) |
| XRP | secp256k1 | Base58 Ripple (r...) |
| TON | Ed25519 | Raw + CRC16 |

#### Architecture Non-Custodial üîê

> [!IMPORTANT]
> **Le syst√®me fonctionne en mode NON-CUSTODIAL partiel** :
> - Les cl√©s priv√©es sont **g√©n√©r√©es c√¥t√© serveur**
> - Stock√©es **chiffr√©es dans Vault** (HashiCorp)
> - Les utilisateurs contr√¥lent leurs fonds via PIN
> - Les transactions sortantes passent par le **Platform Hot Wallet**

**Stockage des cl√©s** :
```go
// vault_client.go
func storeKeyPairInVault(userID, currency, privKey, pubKey, address string) error {
    // Chiffrement et stockage dans Vault
}
```

---

### 6. √âchanges (Exchanges)

**Service** : `exchange-service` (Port 8085)

#### Fonctionnalit√©s

| Feature | Description |
|---------|-------------|
| **Market Orders** | Achat/Vente au prix du march√© |
| **Limit Orders** | Ordres avec prix limite |
| **Stop-Loss** | Protection automatique |
| **P2P Trading** | Trading entre utilisateurs |
| **Quote System** | Devis avant ex√©cution |

#### Taux de Change

Sources : Binance, CoinGecko, Fixer.io, CurrencyLayer

**Tables DB** :
- `exchange_rates` - Taux crypto/fiat
- `exchanges` - Historique des conversions
- `trading_orders` - Ordres en cours
- `p2p_offers` - Offres P2P

---

### 7. Achats/Pr√©l√®vements de Fonds

**Cas d'usage** :

1. **Tickets d'√©v√©nements** (`ticket-service`)
   - Achat de billets
   - D√©bit via transfer-service ‚Üí wallet-service

2. **Dons** (`donation-service`)
   - Contributions aux campagnes
   - Commissions pr√©lev√©es

3. **E-commerce** (`shop-service`)
   - Achats de produits
   - Paiements crypto/fiat

4. **Cartes pr√©pay√©es** (`card-service`)
   - Rechargement de cartes
   - Auto-reload configurable

5. **Associations/Tontines**
   - Cotisations p√©riodiques
   - Pr√™ts communautaires

---

## üìã Dashboard Admin

**URL** : `https://admin.tech-afm.com` (Port 3002)

### Statistiques Affich√©es

```typescript
interface Stats {
    total_users: number;
    active_today: number;
    transactions_today: number;
    volume_today: number;
    total_cards: number;
    active_cards: number;
    total_wallets: number;
    pending_kyc: number;
    verified_kyc: number;
    new_users_today: number;
    transfers_today: number;
}
```

### Sections Disponibles

| Section | Fonctionnalit√© |
|---------|----------------|
| **Users** | Gestion des utilisateurs |
| **KYC** | Validation des documents |
| **Transactions** | Monitoring, blocage, remboursement |
| **Wallets** | Vue des portefeuilles |
| **Cards** | Gestion des cartes |
| **Support** | Tickets support |
| **Logs** | Audit logs |
| **Settings** | Configuration syst√®me |
| **Test Mode** | Mode test/d√©mo |
| **Aggregators** | Gestion des providers |
| **Enterprises** | Comptes entreprises |
| **Shops** | E-commerce |

### Gestion des Transactions

**Actions disponibles** :
- ‚úÖ Voir le d√©tail
- üö´ Bloquer (avec raison)
- ‚Ü©Ô∏è Rembourser (avec raison)
- üìä Filtrer par statut/type/date

---

## üîÑ Suivi des Transactions

### √âtats des Transactions

```
pending ‚Üí processing ‚Üí completed/failed/blocked/cancelled
```

### Tables de Suivi

| Table | Contenu |
|-------|---------|
| `transactions` | Toutes les transactions crypto/fiat |
| `transfers` | Transferts entre utilisateurs |
| `exchanges` | Conversions de devises |
| `card_transactions` | Op√©rations par carte |
| `payment_transactions` | Paiements via providers |

### Events Kafka

Topics principaux :
- `wallet-events` - √âv√©nements wallet
- `transfer-events` - √âv√©nements transfert
- `exchange-events` - √âv√©nements √©change
- `payment_requests` - Demandes de paiement
- `payment_results` - R√©sultats de paiement
- `notifications` - Notifications utilisateur

---

## ‚ö†Ô∏è Points √† Corriger / Am√©liorer

### üî¥ Critiques

1. **Dashboard Admin pas dans le Gateway**
   - Le dashboard est accessible directement, pas via Kong
   - Recommandation : Ajouter les routes admin dans `kong.yml`

2. **Mode Testnet/Mainnet**
   - Variable `CRYPTO_NETWORK` dans docker-compose
   - V√©rifier que le basculement fonctionne correctement
   - Les adresses BTC g√©n√©r√©es en `tb1` (testnet) ou `bc1` (mainnet)

3. **Cl√©s API non configur√©es**
   - Plusieurs cl√©s sont vides dans docker-compose : `TATUM_API_KEY`, `FLUTTERWAVE_SECRET_KEY`, etc.
   - En mode d√©mo c'est OK, mais √† configurer pour la prod

### üü° Importants

4. **S√©curit√© Vault**
   - Token Vault hardcod√© : `dev-token-secure-2024`
   - √Ä remplacer par un syst√®me de secrets management en prod

5. **Monitoring des Sweeps**
   - Le sweep des d√©p√¥ts crypto vers le hot wallet doit √™tre surveill√©
   - Ajouter des alertes si √©chec

6. **Gestion des frais**
   - Les frais r√©seau crypto sont estim√©s mais pas toujours pr√©cis
   - Impl√©menter une marge de s√©curit√©

7. **Confirmations Crypto**
   - Le nombre de confirmations requises devrait √™tre configurable par crypto
   - BTC: 3-6, ETH: 12-30, etc.

### üü¢ Am√©liorations

8. **Dashboard - Graphiques manquants**
   - Ajouter des graphiques temporels (volume, users, etc.)
   - Utiliser des biblioth√®ques comme Chart.js ou Recharts

9. **Export des donn√©es**
   - Ajouter l'export CSV/Excel des transactions
   - Reporting automatis√©

10. **Notifications Push**
    - Le service notification existe mais v√©rifier l'int√©gration Firebase/APNs

11. **Rate Limiting**
    - Configurer les limites dans Kong pour √©viter les abus

12. **Logs structur√©s**
    - Ajouter Elasticsearch/Loki pour les logs centralis√©s

---

## üîê Mod√®le Non-Custodial - Analyse

### Situation Actuelle

Le syst√®me est **semi-custodial** :

| Aspect | Custodial | Non-Custodial |
|--------|-----------|---------------|
| G√©n√©ration des cl√©s | ‚úÖ Serveur | ‚ùå |
| Stockage des cl√©s | ‚úÖ Vault (chiffr√©) | ‚ùå |
| Transactions sortantes | ‚úÖ Via Hot Wallet | ‚ùå |
| Contr√¥le utilisateur | Via PIN | ‚ùå Cl√© priv√©e |
| R√©cup√©ration | ‚úÖ Support peut aider | ‚ùå |

### Pour un Vrai Non-Custodial

Il faudrait :
1. **G√©n√©ration c√¥t√© client** (mobile/web)
2. **Stockage local** de la cl√© priv√©e
3. **Signature locale** des transactions
4. **Seed phrase** fournie √† l'utilisateur

> [!NOTE]
> Le mod√®le actuel est adapt√© pour une n√©obanque o√π la simplicit√© d'usage prime. Un vrai non-custodial n√©cessiterait une refonte majeure de l'UX.

---

## üìù Commandes de D√©veloppement

```bash
# Arr√™ter et supprimer les volumes
docker-compose down -v

# Reconstruire et d√©marrer
docker-compose up -d --build

# Voir les logs d'un service
docker-compose logs -f wallet-service

# Acc√©der √† la DB
docker exec -it postgres psql -U admin -d crypto_bank
```

---

## üìä Sch√©ma de Base de Donn√©es

### Tables Principales (40+)

**Utilisateurs & Auth** :
- `users`, `user_sessions`, `backup_codes`, `verification_tokens`
- `user_preferences`, `notification_preferences`

**Financier** :
- `wallets`, `transactions`, `transfers`, `exchanges`
- `exchange_rates`, `trading_orders`, `p2p_offers`

**Cartes** :
- `cards`, `gift_cards`, `card_transactions`

**KYC & Compliance** :
- `kyc_documents`, `compliance_checks`, `audit_logs`

**Paiements** :
- `payment_providers`, `provider_countries`, `payment_transactions`

**Admin** :
- `admins`, `admin_roles`, `admin_audit_logs`

**Support** :
- `support_tickets`, `chat_messages`

**Associations** :
- `associations`, `association_members`, `association_treasury`, `association_loans`

---

## ‚úÖ R√©sum√©

Cette plateforme est une solution financi√®re compl√®te et bien architectur√©e. Les principaux points forts :

- ‚úÖ Architecture microservices scalable
- ‚úÖ Event-driven avec Kafka
- ‚úÖ Support multi-crypto (BTC, ETH, SOL, TRX, XRP, TON)
- ‚úÖ Support multi-fiat avec providers africains
- ‚úÖ Syst√®me hybride de d√©p√¥ts crypto optimis√©
- ‚úÖ S√©curit√© avec Vault pour les cl√©s
- ‚úÖ Admin dashboard fonctionnel
- ‚úÖ Mode test/d√©mo pour le d√©veloppement

Les axes d'am√©lioration prioritaires :
1. Configurer les cl√©s API pour la production
2. Am√©liorer le dashboard avec des graphiques
3. Ajouter le rate limiting et la s√©curit√©
4. Documenter les processus de d√©ploiement
