# Logstash Pipeline - Collect logs from microservices
input {
  # TCP input for direct log shipping
  tcp {
    port => 5000
    codec => json_lines
    tags => ["microservice"]
  }

  # Beats input (Filebeat)
  beats {
    port => 5044
    tags => ["filebeat"]
  }
}

filter {
  # Parse JSON logs from microservices
  if [message] =~ /^\{/ {
    json {
      source => "message"
      target => "parsed"
    }
  }

  # Extract service name from container name
  if [container][name] {
    mutate {
      add_field => { "service" => "%{[container][name]}" }
    }
    # Clean up service name (remove prefix)
    mutate {
      gsub => [ "service", "microservices-financial-app[-_]", "" ]
      gsub => [ "service", "[-_]1$", "" ]
    }
  }

  # Parse Go service logs
  if [parsed][level] {
    mutate {
      rename => { "[parsed][level]" => "log_level" }
      rename => { "[parsed][msg]" => "log_message" }
      rename => { "[parsed][time]" => "log_time" }
    }
  }

  # Add timestamp if missing
  if ![log_time] {
    ruby {
      code => "event.set('log_time', Time.now.utc.iso8601)"
    }
  }

  # Categorize by service type
  if [service] =~ /auth/ {
    mutate { add_field => { "service_type" => "authentication" } }
  } else if [service] =~ /wallet/ {
    mutate { add_field => { "service_type" => "financial" } }
  } else if [service] =~ /transfer/ {
    mutate { add_field => { "service_type" => "financial" } }
  } else if [service] =~ /exchange/ {
    mutate { add_field => { "service_type" => "trading" } }
  } else if [service] =~ /card/ {
    mutate { add_field => { "service_type" => "financial" } }
  } else if [service] =~ /notification/ {
    mutate { add_field => { "service_type" => "messaging" } }
  } else if [service] =~ /admin/ {
    mutate { add_field => { "service_type" => "administration" } }
  } else if [service] =~ /support/ {
    mutate { add_field => { "service_type" => "support" } }
  } else if [service] =~ /ticket/ {
    mutate { add_field => { "service_type" => "events" } }
  } else if [service] =~ /association/ {
    mutate { add_field => { "service_type" => "community" } }
  } else {
    mutate { add_field => { "service_type" => "infrastructure" } }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => ["@version", "host", "port"]
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "zekora-logs-%{+YYYY.MM.dd}"
  }

  # Debug output (comment in production)
  # stdout { codec => rubydebug }
}
